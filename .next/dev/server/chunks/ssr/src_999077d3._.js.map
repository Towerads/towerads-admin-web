{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/slava/OneDrive/%D0%A0%D0%B0%D0%B1%D0%BE%D1%87%D0%B8%D0%B9%20%D1%81%D1%82%D0%BE%D0%BB/USL/towerads-admin-web/src/lib/api.ts"],"sourcesContent":["const API_URL = process.env.NEXT_PUBLIC_API_URL!;\r\n\r\nexport async function api(\r\n  path: string,\r\n  options: RequestInit = {}\r\n): Promise<any> {\r\n  const token =\r\n    typeof window !== \"undefined\"\r\n      ? localStorage.getItem(\"admin_token\")\r\n      : null;\r\n\r\n  const res = await fetch(`${API_URL}${path}`, {\r\n    ...options,\r\n    headers: {\r\n      \"Content-Type\": \"application/json\",\r\n      ...(token ? { Authorization: `Bearer ${token}` } : {}),\r\n      ...(options.headers || {}),\r\n    },\r\n  });\r\n\r\n  if (!res.ok) {\r\n    const text = await res.text();\r\n    throw new Error(text || `API error ${res.status}`);\r\n  }\r\n\r\n  return res.json();\r\n}\r\n"],"names":[],"mappings":";;;;AAAA,MAAM;AAEC,eAAe,IACpB,IAAY,EACZ,UAAuB,CAAC,CAAC;IAEzB,MAAM,QACJ,sCACI,0BACA;IAEN,MAAM,MAAM,MAAM,MAAM,GAAG,UAAU,MAAM,EAAE;QAC3C,GAAG,OAAO;QACV,SAAS;YACP,gBAAgB;YAChB,GAAI,sCAAQ,0BAAuC,CAAC,CAAC;YACrD,GAAI,QAAQ,OAAO,IAAI,CAAC,CAAC;QAC3B;IACF;IAEA,IAAI,CAAC,IAAI,EAAE,EAAE;QACX,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,IAAI,MAAM,QAAQ,CAAC,UAAU,EAAE,IAAI,MAAM,EAAE;IACnD;IAEA,OAAO,IAAI,IAAI;AACjB"}},
    {"offset": {"line": 29, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/slava/OneDrive/%D0%A0%D0%B0%D0%B1%D0%BE%D1%87%D0%B8%D0%B9%20%D1%81%D1%82%D0%BE%D0%BB/USL/towerads-admin-web/src/app/%28admin%29/providers/page.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport { useEffect, useMemo, useRef, useState } from \"react\";\r\nimport { api } from \"@/lib/api\";\r\n\r\ntype Provider = {\r\n  placement_id: string;\r\n  provider: string;\r\n  status: \"active\" | \"paused\";\r\n  traffic_percentage: number;\r\n};\r\n\r\nexport default function ProvidersPage() {\r\n  const [rows, setRows] = useState<Provider[]>([]);\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  // чтобы не дергать бек при каждом движении слайдера\r\n  const pendingTrafficRef = useRef<Record<string, number>>({});\r\n\r\n  // --------------------\r\n  // LOAD DATA\r\n  // --------------------\r\n  const load = async () => {\r\n    setLoading(true);\r\n    try {\r\n      const data = await api(\"/admin/mediation\");\r\n      setRows(data.providers || []);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    load();\r\n  }, []);\r\n\r\n  // --------------------\r\n  // ACTIONS\r\n  // --------------------\r\n  const toggleStatus = async (row: Provider) => {\r\n    await api(\"/admin/mediation/toggle\", {\r\n      method: \"POST\",\r\n      body: JSON.stringify({\r\n        placement_id: row.placement_id,\r\n        provider: row.provider,\r\n        status: row.status === \"active\" ? \"paused\" : \"active\",\r\n      }),\r\n    });\r\n    load();\r\n  };\r\n\r\n  const updateTrafficUI = (row: Provider, value: number) => {\r\n    const key = `${row.placement_id}__${row.provider}`;\r\n    pendingTrafficRef.current[key] = value;\r\n\r\n    setRows((prev) =>\r\n      prev.map((r) =>\r\n        r.placement_id === row.placement_id && r.provider === row.provider\r\n          ? { ...r, traffic_percentage: value }\r\n          : r\r\n      )\r\n    );\r\n  };\r\n\r\n  const commitTraffic = async (row: Provider) => {\r\n    const key = `${row.placement_id}__${row.provider}`;\r\n    const value = pendingTrafficRef.current[key];\r\n\r\n    if (value === undefined) return;\r\n\r\n    await api(\"/admin/mediation/traffic\", {\r\n      method: \"POST\",\r\n      body: JSON.stringify({\r\n        placement_id: row.placement_id,\r\n        provider: row.provider,\r\n        traffic_percentage: value,\r\n      }),\r\n    });\r\n\r\n    delete pendingTrafficRef.current[key];\r\n  };\r\n\r\n  // --------------------\r\n  // DERIVED VALUES\r\n  // --------------------\r\n  const activeCount = useMemo(\r\n    () => rows.filter((r) => r.status === \"active\").length,\r\n    [rows]\r\n  );\r\n\r\n  const totalTraffic = useMemo(() => {\r\n    return rows.reduce((sum, r) => {\r\n      if (r.status !== \"active\") return sum;\r\n      return sum + Number(r.traffic_percentage || 0);\r\n    }, 0);\r\n  }, [rows]);\r\n\r\n  const trafficValid = totalTraffic === 100;\r\n\r\n  // --------------------\r\n  // RENDER\r\n  // --------------------\r\n  return (\r\n    <div className=\"page-inner\">\r\n      {/* ===== Header ===== */}\r\n      <div className=\"page-header\">\r\n        <div>\r\n          <h1 className=\"page-title\">Providers</h1>\r\n          <p className=\"page-subtitle\">\r\n            Manage traffic distribution between ad providers\r\n          </p>\r\n        </div>\r\n\r\n        <button type=\"button\" className=\"btn-secondary\">\r\n          Add provider\r\n        </button>\r\n      </div>\r\n\r\n      {/* ===== Compact summary bar ===== */}\r\n      <div className=\"providers-summary\">\r\n        <div className=\"summary-item\">\r\n          <span className=\"summary-label\">Providers</span>\r\n          <strong className=\"summary-value\">{rows.length}</strong>\r\n        </div>\r\n\r\n        <div className=\"summary-item\">\r\n          <span className=\"summary-label\">Active</span>\r\n          <strong className=\"summary-value\">{activeCount}</strong>\r\n        </div>\r\n\r\n        <div className=\"summary-item\">\r\n          <span className=\"summary-label\">Traffic</span>\r\n          <strong\r\n            className={`summary-value ${\r\n              trafficValid ? \"ok\" : \"danger\"\r\n            }`}\r\n          >\r\n            {totalTraffic}%\r\n          </strong>\r\n          {!trafficValid && (\r\n            <span className=\"summary-hint\">must be 100%</span>\r\n          )}\r\n        </div>\r\n\r\n        <div className=\"summary-item\">\r\n          <span className=\"summary-label\">Fill rate</span>\r\n          <strong className=\"summary-value\">96%</strong>\r\n        </div>\r\n      </div>\r\n\r\n      {/* ===== Table ===== */}\r\n      <div className=\"table-card\">\r\n        <table className=\"table\">\r\n          <thead>\r\n            <tr>\r\n              <th>Provider</th>\r\n              <th>Status</th>\r\n              <th>Traffic</th>\r\n              <th style={{ width: 140 }} />\r\n            </tr>\r\n          </thead>\r\n\r\n          <tbody>\r\n            {rows.map((r) => {\r\n              const disabled = r.status !== \"active\";\r\n\r\n              return (\r\n                <tr\r\n                  key={`${r.placement_id}-${r.provider}`}\r\n                  className={disabled ? \"row-disabled\" : \"\"}\r\n                >\r\n                  <td className=\"capitalize\">{r.provider}</td>\r\n\r\n                  <td>\r\n                    <span\r\n                      className={\r\n                        r.status === \"active\"\r\n                          ? \"badge-active\"\r\n                          : \"badge-paused\"\r\n                      }\r\n                    >\r\n                      {r.status}\r\n                    </span>\r\n                  </td>\r\n\r\n                  <td className=\"traffic-cell\">\r\n                    <input\r\n                      type=\"range\"\r\n                      min={0}\r\n                      max={100}\r\n                      value={Number(r.traffic_percentage || 0)}\r\n                      disabled={disabled}\r\n                      onChange={(e) =>\r\n                        updateTrafficUI(r, Number(e.target.value))\r\n                      }\r\n                      onMouseUp={() => commitTraffic(r)}\r\n                      onTouchEnd={() => commitTraffic(r)}\r\n                    />\r\n                    <div className=\"traffic-value\">\r\n                      {Number(r.traffic_percentage || 0)}%\r\n                    </div>\r\n                  </td>\r\n\r\n                  <td className=\"text-right\">\r\n                    <button\r\n                      type=\"button\"\r\n                      className={\r\n                        r.status === \"active\"\r\n                          ? \"btn-danger\"\r\n                          : \"btn-success\"\r\n                      }\r\n                      onClick={() => toggleStatus(r)}\r\n                    >\r\n                      {r.status === \"active\" ? \"Disable\" : \"Enable\"}\r\n                    </button>\r\n                  </td>\r\n                </tr>\r\n              );\r\n            })}\r\n          </tbody>\r\n        </table>\r\n\r\n        {loading && <div className=\"loading\">Loading…</div>}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"names":[],"mappings":"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"}}]
}